---
/**
 * VenueDetailPanelV3 - Slide-in panel showing full venue details
 * New design with logo/initials header, dish list layout (left: title+ingredients+price, right: image)
 */
import IconsV3 from './icons/IconsV3.astro';

export interface Props {
  translations: {
    products: string;
    dishesWithPlanted: string;
    close: string;
    route: string;
    orderNow: string;
    dishes: string;
    delivery: string;
  };
}

const { translations } = Astro.props;
---

<div class="panel-overlay" id="v3DetailOverlay">
  <aside class="detail-panel" id="v3DetailPanel">
    <header class="panel-header">
      <button class="panel-close" id="v3DetailClose" type="button" aria-label={translations.close}>
        <IconsV3 name="close" />
      </button>

      <div class="panel-identity">
        <div class="panel-logo" id="v3PanelLogo">
          <span class="panel-logo-placeholder" id="v3PanelLogoText"></span>
        </div>
        <div class="panel-info">
          <h2 class="panel-name" id="v3DetailName">Venue Name</h2>
          <div class="panel-meta">
            <span id="v3DetailType"></span>
            <span class="panel-distance" id="v3DetailDistance"></span>
          </div>
        </div>
      </div>

      <div class="panel-stats">
        <div class="panel-stat">
          <div class="panel-stat-value" id="v3DishCount">0</div>
          <div class="panel-stat-label">{translations.dishes}</div>
        </div>
        <div class="panel-stat">
          <div class="panel-stat-value">~15'</div>
          <div class="panel-stat-label">{translations.delivery}</div>
        </div>
      </div>
    </header>

    <div class="panel-content">
      <div class="panel-section-title">{translations.products}</div>
      <div class="panel-products" id="v3DetailProducts"></div>

      <div class="panel-section-title">{translations.dishesWithPlanted}</div>
      <div class="dishes-list" id="v3DetailDishes"></div>
    </div>

    <div class="panel-tagline" id="v3PanelTagline">
      <strong id="v3TaglineCount"></strong> mit pflanzlichem Protein. Schmeckt nicht nach Verzicht.
    </div>

    <footer class="panel-footer">
      <a href="#" class="panel-cta panel-cta-secondary" id="v3RouteButton">
        <IconsV3 name="location" />
        {translations.route}
      </a>
      <a href="#" class="panel-cta panel-cta-primary" id="v3OrderButton">
        {translations.orderNow}
      </a>
    </footer>
  </aside>
</div>

<script>
  // Detail Panel Controller
  class V3DetailPanel {
    private overlay: HTMLElement | null;
    private panel: HTMLElement | null;
    private closeBtn: HTMLElement | null;
    private nameEl: HTMLElement | null;
    private typeEl: HTMLElement | null;
    private distanceEl: HTMLElement | null;
    private logoEl: HTMLElement | null;
    private logoTextEl: HTMLElement | null;
    private dishCountEl: HTMLElement | null;
    private productsEl: HTMLElement | null;
    private dishesEl: HTMLElement | null;
    private taglineCountEl: HTMLElement | null;
    private routeButtonEl: HTMLElement | null;
    private orderButtonEl: HTMLElement | null;
    private currentVenue: any = null;

    constructor() {
      this.overlay = document.getElementById('v3DetailOverlay');
      this.panel = document.getElementById('v3DetailPanel');
      this.closeBtn = document.getElementById('v3DetailClose');
      this.nameEl = document.getElementById('v3DetailName');
      this.typeEl = document.getElementById('v3DetailType');
      this.distanceEl = document.getElementById('v3DetailDistance');
      this.logoEl = document.getElementById('v3PanelLogo');
      this.logoTextEl = document.getElementById('v3PanelLogoText');
      this.dishCountEl = document.getElementById('v3DishCount');
      this.productsEl = document.getElementById('v3DetailProducts');
      this.dishesEl = document.getElementById('v3DetailDishes');
      this.taglineCountEl = document.getElementById('v3TaglineCount');
      this.routeButtonEl = document.getElementById('v3RouteButton');
      this.orderButtonEl = document.getElementById('v3OrderButton');

      this.init();
    }

    private init() {
      // Close button
      this.closeBtn?.addEventListener('click', () => this.hide());

      // Click outside to close
      this.overlay?.addEventListener('click', (e) => {
        if (e.target === this.overlay) this.hide();
      });

      // ESC key to close
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.overlay?.classList.contains('active')) {
          this.hide();
        }
      });

      // Listen for venue card clicks
      document.addEventListener('click', (e) => {
        const card = (e.target as HTMLElement).closest('.v3-venue-card');
        if (card) {
          const venueId = card.getAttribute('data-venue-id');
          if (venueId) {
            this.showVenueById(venueId);
          }
        }
      });
    }

    private generateLogoInitials(name: string): string {
      // Extract first letter of each word, max 3 letters
      const words = name.split(/[\s&-]+/).filter(w => w.length > 0);
      if (words.length === 0) return '?';

      // Get first letter of first 2-3 words
      const initials = words
        .slice(0, 3)
        .map(w => w[0].toUpperCase())
        .join('');

      return initials || '?';
    }

    public showVenueById(venueId: string) {
      // Get venue data from the global venues array
      const venues = (window as any).__v3Venues || [];
      const venue = venues.find((v: any) => v.id === venueId);
      if (venue) {
        this.show(venue);
      }
    }

    public show(venue: any) {
      this.currentVenue = venue;

      // Update name
      if (this.nameEl) {
        this.nameEl.textContent = venue.name;
      }

      // Update type and location
      if (this.typeEl) {
        this.typeEl.textContent = `${venue.location || ''} Â· ${venue.category || 'Restaurant'}`.trim();
      }

      // Update distance
      if (this.distanceEl) {
        this.distanceEl.textContent = venue.distance || '';
      }

      // Update logo - show image or initials
      if (this.logoEl && this.logoTextEl) {
        if (venue.logo) {
          this.logoEl.innerHTML = `<img src="${venue.logo}" alt="${venue.name}" loading="lazy">`;
        } else {
          const initials = this.generateLogoInitials(venue.name);
          this.logoTextEl.textContent = initials;
        }
      }

      // Update dish count
      const dishCount = venue.dishes?.length || 0;
      if (this.dishCountEl) {
        this.dishCountEl.textContent = dishCount.toString();
      }

      // Update tagline count
      if (this.taglineCountEl) {
        this.taglineCountEl.textContent = `${dishCount} Gerichte`;
      }

      // Update products with dot icon
      if (this.productsEl) {
        const dotIconSvg = '<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8"/></svg>';
        this.productsEl.innerHTML = (venue.products || []).map((p: string) =>
          `<span class="panel-product-tag">${dotIconSvg}${p}</span>`
        ).join('');
      }

      // Update dishes with NEW LAYOUT: content left, image right
      if (this.dishesEl) {
        const placeholderIconSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <path d="M21 15l-5-5L5 21"/>
        </svg>`;

        this.dishesEl.innerHTML = (venue.dishes || []).map((dish: any) => {
          const ingredients = dish.ingredients || dish.description || '';

          return `
            <div class="dish-item">
              <div class="dish-content">
                <div class="dish-name">${dish.name || 'Unnamed Dish'}</div>
                ${ingredients ? `<div class="dish-ingredients">${ingredients}</div>` : ''}
                <div class="dish-price">${dish.price || ''}</div>
              </div>
              <div class="dish-image">
                ${dish.image
                  ? `<img src="${dish.image}" alt="${dish.name}" loading="lazy">`
                  : `<div class="dish-image-placeholder">${placeholderIconSvg}</div>`
                }
              </div>
            </div>
          `;
        }).join('');
      }

      // Update footer buttons
      if (this.routeButtonEl && venue.mapsUrl) {
        (this.routeButtonEl as HTMLAnchorElement).href = venue.mapsUrl;
      }
      if (this.orderButtonEl && venue.orderUrl) {
        (this.orderButtonEl as HTMLAnchorElement).href = venue.orderUrl;
      }

      // Show panel
      this.overlay?.classList.add('active');
      this.panel?.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Focus management for accessibility
      this.closeBtn?.focus();
    }

    public hide() {
      this.overlay?.classList.remove('active');
      this.panel?.classList.remove('active');
      document.body.style.overflow = '';
      this.currentVenue = null;
    }
  }

  // Initialize panel controller
  document.addEventListener('DOMContentLoaded', () => {
    (window as any).__v3DetailPanel = new V3DetailPanel();
  });

  // Also initialize on astro:page-load for client-side navigation
  document.addEventListener('astro:page-load', () => {
    if (!(window as any).__v3DetailPanel) {
      (window as any).__v3DetailPanel = new V3DetailPanel();
    }
  });
</script>
