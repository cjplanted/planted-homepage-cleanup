---
interface Translations {
    badge?: string;
    title?: string;
    description?: string;
    placeholder?: string;
    button?: string;
    consent?: string;
    success?: string;
}

interface Props {
    variant?: 'default' | 'footer' | 'inline';
    translations?: Translations;
}

const { variant = 'default', translations = {} } = Astro.props;

// Default English translations
const t = {
    badge: translations.badge || "Stay in the loop",
    title: translations.title || "Hungry for more?",
    description: translations.description || "Get recipes, product news, and exclusive offers. We promise to keep it tasty, not spammy.",
    placeholder: translations.placeholder || "Your email address",
    button: translations.button || "Subscribe",
    consent: translations.consent || "I agree to receive marketing emails.",
    success: translations.success || "Thanks for subscribing! Check your inbox.",
};
---

<section class={`newsletter-signup ${variant}`}>
    <div class="newsletter-inner">
        {variant === 'default' && (
            <div class="newsletter-content reveal">
                <span class="newsletter-badge">{t.badge}</span>
                <h3>{t.title}</h3>
                <p>{t.description}</p>
            </div>
        )}
        {variant === 'footer' && (
            <div class="newsletter-content">
                <p>{t.description}</p>
            </div>
        )}
        <form class="newsletter-form reveal" data-newsletter-form data-success-message={t.success}>
            <div class="form-row">
                <div class="input-wrapper">
                    <input
                        type="email"
                        name="email"
                        placeholder={t.placeholder}
                        required
                        class="newsletter-input"
                    />
                </div>
                <select name="country" class="newsletter-country" aria-label="Select your country">
                    <option value="ch">ðŸ‡¨ðŸ‡­ Switzerland</option>
                    <option value="de">ðŸ‡©ðŸ‡ª Germany</option>
                    <option value="at">ðŸ‡¦ðŸ‡¹ Austria</option>
                    <option value="fr">ðŸ‡«ðŸ‡· France</option>
                    <option value="it">ðŸ‡®ðŸ‡¹ Italy</option>
                    <option value="nl">ðŸ‡³ðŸ‡± Netherlands</option>
                    <option value="uk">ðŸ‡¬ðŸ‡§ United Kingdom</option>
                    <option value="es">ðŸ‡ªðŸ‡¸ Spain</option>
                </select>
                <button type="submit" class="newsletter-button">
                    <span class="button-text">{t.button}</span>
                    <span class="button-loading" hidden>
                        <svg class="spinner" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="60" stroke-dashoffset="20"/>
                        </svg>
                    </span>
                    <svg class="button-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
            <div class="newsletter-consent">
                <label>
                    <input type="checkbox" name="consent" required />
                    <span>{t.consent} <a href="#" data-privacy-link-newsletter>Privacy Policy</a></span>
                </label>
            </div>
            <div class="newsletter-message" hidden></div>
        </form>
    </div>

    {variant === 'default' && (
        <>
            <div class="newsletter-decor decor-1"></div>
            <div class="newsletter-decor decor-2"></div>
        </>
    )}
</section>

<script>
    // Set privacy link based on current locale
    document.addEventListener('DOMContentLoaded', () => {
        const privacyLinks = document.querySelectorAll('[data-privacy-link-newsletter]');
        const pathParts = window.location.pathname.split('/').filter(Boolean);
        let locale = 'ch-de'; // default
        const localePattern = /^(global|ch-de|ch-fr|ch-it|ch-en|de|de-en|at|at-en|it|it-en|fr|fr-en|nl|nl-en|uk|es|es-en)$/;
        for (const part of pathParts) {
            if (localePattern.test(part)) {
                locale = part;
                break;
            }
        }
        privacyLinks.forEach(link => {
            (link as HTMLAnchorElement).href = `/${locale}/privacy`;
        });
    });

    document.querySelectorAll('[data-newsletter-form]').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formEl = e.target as HTMLFormElement;
            const formData = new FormData(formEl);
            const button = formEl.querySelector('.newsletter-button') as HTMLButtonElement;
            const buttonText = formEl.querySelector('.button-text') as HTMLElement;
            const buttonLoading = formEl.querySelector('.button-loading') as HTMLElement;
            const buttonArrow = formEl.querySelector('.button-arrow') as HTMLElement;
            const message = formEl.querySelector('.newsletter-message') as HTMLElement;

            // Collect form data
            const email = formData.get('email') as string;
            const country = formData.get('country') as string;
            const consent = formData.get('consent') === 'on';

            // Validate
            if (!email || !consent) {
                message.innerHTML = '<span class="error-icon">!</span> Please fill in all required fields.';
                message.className = 'newsletter-message error';
                message.hidden = false;
                return;
            }

            // Show loading state
            button.disabled = true;
            buttonText.hidden = true;
            buttonArrow.style.display = 'none';
            buttonLoading.hidden = false;

            try {
                // API endpoint configuration
                // Replace this URL with your actual newsletter API endpoint
                // Options: Mailchimp, SendGrid, ConvertKit, or custom backend
                const API_ENDPOINT = '/api/newsletter'; // Configure your endpoint here

                // For now, we'll simulate the API call
                // In production, uncomment the fetch call below and configure your endpoint
                /*
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email,
                        country,
                        consent,
                        source: 'website',
                        timestamp: new Date().toISOString(),
                    }),
                });

                if (!response.ok) {
                    throw new Error('Subscription failed');
                }
                */

                // Simulate API delay (remove in production)
                await new Promise(resolve => setTimeout(resolve, 1200));

                // Store subscription locally (for analytics/tracking)
                try {
                    const subscriptions = JSON.parse(localStorage.getItem('planted_newsletter_pending') || '[]');
                    subscriptions.push({ email, country, timestamp: new Date().toISOString() });
                    localStorage.setItem('planted_newsletter_pending', JSON.stringify(subscriptions));
                } catch (storageError) {
                    // localStorage not available
                }

                // Show success
                const successMessage = formEl.dataset.successMessage || 'Thanks for subscribing! Check your inbox.';
                message.innerHTML = '<span class="success-icon">âœ“</span> ' + successMessage;
                message.className = 'newsletter-message success';
                message.hidden = false;
                formEl.reset();

            } catch (error) {
                // Show error
                message.innerHTML = '<span class="error-icon">!</span> Something went wrong. Please try again.';
                message.className = 'newsletter-message error';
                message.hidden = false;
            }

            // Reset button
            button.disabled = false;
            buttonText.hidden = false;
            buttonArrow.style.display = '';
            buttonLoading.hidden = true;

            // Hide message after delay
            setTimeout(() => {
                message.hidden = true;
            }, 5000);
        });
    });
</script>

<style>
    .newsletter-signup {
        --input-bg: white;
        --input-border: rgba(255,255,255,0.2);
    }

    .newsletter-signup.default {
        background: var(--planted-cream);
        padding: 5rem 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .newsletter-inner {
        max-width: 700px;
        margin: 0 auto;
        text-align: center;
        position: relative;
        z-index: 1;
    }

    .newsletter-badge {
        display: inline-block;
        background: var(--planted-purple);
        color: white;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        padding: 0.5rem 1rem;
        border-radius: 100px;
        margin-bottom: 1.25rem;
    }

    .newsletter-content h3 {
        font-family: 'VC Henrietta', serif;
        font-size: clamp(2rem, 6vw, 3rem);
        color: var(--planted-purple);
        margin-bottom: 0.75rem;
        line-height: 1;
    }

    .newsletter-content p {
        font-size: 1.1rem;
        color: var(--planted-black);
        opacity: 0.7;
        margin-bottom: 2rem;
        max-width: 450px;
        margin-left: auto;
        margin-right: auto;
    }

    .newsletter-form {
        max-width: 600px;
        margin: 0 auto;
    }

    .form-row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .input-wrapper {
        flex: 1;
        min-width: 220px;
    }

    .newsletter-input {
        width: 100%;
        padding: 1rem 1.5rem;
        border: 2px solid rgba(97, 38, 158, 0.15);
        border-radius: 100px;
        font-family: inherit;
        font-size: 1rem;
        background: white;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .newsletter-input:focus {
        outline: none;
        border-color: var(--planted-purple);
        box-shadow: 0 0 0 4px rgba(97, 38, 158, 0.1);
    }

    .newsletter-country {
        padding: 1rem 1.25rem;
        border: 2px solid rgba(97, 38, 158, 0.15);
        border-radius: 100px;
        font-family: inherit;
        font-size: 1rem;
        background: white;
        cursor: pointer;
        min-width: 160px;
        transition: border-color 0.2s;
    }

    .newsletter-country:focus {
        outline: none;
        border-color: var(--planted-purple);
    }

    .newsletter-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem 2rem;
        background: var(--planted-purple);
        color: white;
        border: none;
        border-radius: 100px;
        font-family: inherit;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
        min-width: 160px;
        box-shadow: 0 4px 16px rgba(97, 38, 158, 0.25);
    }

    .newsletter-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(97, 38, 158, 0.35);
    }

    .newsletter-button:disabled {
        opacity: 0.8;
        cursor: not-allowed;
    }

    .button-arrow {
        width: 18px;
        height: 18px;
        transition: transform 0.2s;
    }

    .newsletter-button:hover .button-arrow {
        transform: translateX(3px);
    }

    .spinner {
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .newsletter-consent {
        margin-top: 1rem;
        font-size: 0.85rem;
        color: var(--planted-black);
        opacity: 0.7;
    }

    .newsletter-consent label {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        justify-content: center;
        cursor: pointer;
    }

    .newsletter-consent input[type="checkbox"] {
        margin-top: 0.2rem;
        accent-color: var(--planted-purple);
        width: 16px;
        height: 16px;
    }

    .newsletter-consent a {
        color: var(--planted-purple);
        text-decoration: underline;
    }

    .newsletter-message {
        margin-top: 1rem;
        padding: 1rem 1.5rem;
        border-radius: 100px;
        font-size: 0.95rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .newsletter-message.success {
        background: rgba(107, 191, 89, 0.15);
        color: #3d8c3d;
    }

    .newsletter-message.error {
        background: rgba(220, 53, 69, 0.15);
        color: #dc3545;
    }

    .success-icon {
        font-size: 1.1rem;
    }

    /* Decorative elements */
    .newsletter-decor {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
    }

    .decor-1 {
        width: 200px;
        height: 200px;
        background: rgba(97, 38, 158, 0.05);
        top: -50px;
        left: -50px;
    }

    .decor-2 {
        width: 150px;
        height: 150px;
        background: rgba(107, 191, 89, 0.08);
        bottom: -30px;
        right: -30px;
    }

    /* Footer variant styling */
    .newsletter-signup.footer {
        padding: 1.5rem 0;
    }

    .newsletter-signup.footer .newsletter-content p {
        margin-bottom: 1rem;
        opacity: 0.7;
        font-size: 0.9rem;
        color: white;
    }

    .newsletter-signup.footer .form-row {
        justify-content: flex-start;
    }

    .newsletter-signup.footer .newsletter-input {
        max-width: 250px;
        border-color: rgba(255, 255, 255, 0.2);
    }

    .newsletter-signup.footer .newsletter-country {
        display: none;
    }

    .newsletter-signup.footer .newsletter-consent {
        color: white;
        opacity: 0.6;
    }

    .newsletter-signup.footer .newsletter-consent label {
        justify-content: flex-start;
    }

    .newsletter-signup.footer .newsletter-consent a {
        color: white;
    }

    /* Inline variant */
    .newsletter-signup.inline {
        padding: 2rem;
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
    }

    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }

        .newsletter-input,
        .newsletter-country,
        .newsletter-button {
            width: 100%;
            min-width: auto;
        }

        .newsletter-signup.footer .newsletter-input {
            max-width: none;
        }

        .input-wrapper {
            min-width: auto;
        }
    }

    @media (min-width: 1024px) {
        .newsletter-signup.default {
            padding: 6rem 3rem;
        }
    }

    @media (min-width: 1440px) {
        .newsletter-signup.default {
            padding: 8rem 5rem;
        }
    }
</style>
