---
import { getCollection } from 'astro:content';
import { deliveryRestaurants, platformColors, type DeliveryRestaurant } from '../data/deliveryRestaurants';

interface Translations {
    detecting?: string;
    showingResults?: string;
    change?: string;
    stores?: string;
    restaurants?: string;
    delivery?: string;
    noRetail?: string;
    noFoodservice?: string;
    noDelivery?: string;
    foodserviceIntro?: string;
    deliveryIntro?: string;
    availableProducts?: string;
    orderNow?: string;
    viewMenu?: string;
    vegan?: string;
    cantFind?: string;
    orderOnline?: string;
    shopOnline?: string;
}

interface Props {
    title?: string;
    subtitle?: string;
    translations?: Translations;
    locale?: string;
}

const {
    title = "Find Us",
    subtitle = "Discover where to get your planted fix.",
    translations = {},
    locale
} = Astro.props;

// Default English translations
const t = {
    detecting: translations.detecting || "Finding your location...",
    showingResults: translations.showingResults || "Showing results for",
    change: translations.change || "Change",
    stores: translations.stores || "Stores",
    restaurants: translations.restaurants || "Restaurants",
    delivery: translations.delivery || "Delivery",
    noRetail: translations.noRetail || "No retail partners found in your area.",
    noFoodservice: translations.noFoodservice || "No restaurant partners yet. Stay tuned!",
    noDelivery: translations.noDelivery || "No delivery partners in your area yet.",
    foodserviceIntro: translations.foodserviceIntro || "We're proud to partner with restaurants and foodservice providers who share our passion for delicious, sustainable food.",
    deliveryIntro: translations.deliveryIntro || "Order planted dishes directly to your door from these partner restaurants.",
    availableProducts: translations.availableProducts || "Available products:",
    orderNow: translations.orderNow || "Order now",
    viewMenu: translations.viewMenu || "View menu",
    vegan: translations.vegan || "Vegan",
    cantFind: translations.cantFind || "Can't find a store?",
    orderOnline: translations.orderOnline || "Order directly from our online shop and get planted delivered to your door.",
    shopOnline: translations.shopOnline || "Shop Online",
};

const base = import.meta.env.BASE_URL;

// Get retailer and product data
const retailers = await getCollection('retailers');
const products = await getCollection('products');

// Create product lookup map
const productMap = new Map(products.map(p => [p.id, p.data]));

// Map locale codes to country info
const localeToCountry: Record<string, { name: string; code: string; flag: string }> = {
    'ch-de': { name: 'Switzerland', code: 'CH', flag: 'ðŸ‡¨ðŸ‡­' },
    'ch-fr': { name: 'Switzerland', code: 'CH', flag: 'ðŸ‡¨ðŸ‡­' },
    'ch-it': { name: 'Switzerland', code: 'CH', flag: 'ðŸ‡¨ðŸ‡­' },
    'de': { name: 'Germany', code: 'DE', flag: 'ðŸ‡©ðŸ‡ª' },
    'at': { name: 'Austria', code: 'AT', flag: 'ðŸ‡¦ðŸ‡¹' },
    'it': { name: 'Italy', code: 'IT', flag: 'ðŸ‡®ðŸ‡¹' },
    'fr': { name: 'France', code: 'FR', flag: 'ðŸ‡«ðŸ‡·' },
    'nl': { name: 'Netherlands', code: 'NL', flag: 'ðŸ‡³ðŸ‡±' },
    'uk': { name: 'United Kingdom', code: 'GB', flag: 'ðŸ‡¬ðŸ‡§' },
    'es': { name: 'Spain', code: 'ES', flag: 'ðŸ‡ªðŸ‡¸' }
};

// Country code to name mapping for IP detection
const countryCodeToName: Record<string, string> = {
    'CH': 'Switzerland',
    'DE': 'Germany',
    'AT': 'Austria',
    'IT': 'Italy',
    'FR': 'France',
    'NL': 'Netherlands',
    'GB': 'United Kingdom',
    'ES': 'Spain'
};

// Group retailers by type
const retailPartners = retailers.filter(r => r.data.type !== 'foodservice').sort((a, b) => (a.data.order || 99) - (b.data.order || 99));
const foodservicePartners = retailers.filter(r => r.data.type === 'foodservice').sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

// Get unique countries from all retailers
const allCountries = new Set<string>();
retailers.forEach(r => {
    r.data.countries.forEach(locale => {
        const country = localeToCountry[locale];
        if (country) allCountries.add(country.name);
    });
});
const countries = Array.from(allCountries).sort();

// Country code to full name for delivery restaurants
const deliveryCountryMap: Record<string, string> = {
    'ch': 'Switzerland',
    'de': 'Germany',
    'at': 'Austria',
    'nl': 'Netherlands',
    'uk': 'United Kingdom',
    'fr': 'France',
    'it': 'Italy',
    'es': 'Spain'
};

// Helper to get country name from locale
function getCountryName(locale: string): string {
    return localeToCountry[locale]?.name || locale;
}

// Helper to get countries for retailer
function getRetailerCountries(retailer: typeof retailers[0]): string[] {
    const countrySet = new Set<string>();
    retailer.data.countries.forEach(locale => {
        const country = localeToCountry[locale];
        if (country) countrySet.add(country.name);
    });
    return Array.from(countrySet);
}
---

<section class="store-locator" id="locator">
    <div class="locator-inner">
        <!-- Header with country detection -->
        <div class="locator-header reveal">
            <h2>{title}</h2>
            <p class="subtitle">{subtitle}</p>

            <!-- Detected country display -->
            <div class="country-detected" id="countryDetected">
                <div class="detecting">
                    <span class="spinner"></span>
                    <span>{t.detecting}</span>
                </div>
                <div class="detected" style="display: none;">
                    <span class="flag" id="countryFlag"></span>
                    <span>{t.showingResults} <strong id="countryName"></strong></span>
                    <button class="change-country" id="changeCountry">{t.change}</button>
                </div>
            </div>

            <!-- Country selector (hidden by default, shown when changing) -->
            <div class="country-selector" id="countrySelector" style="display: none;">
                <div class="selector-inner">
                    {countries.map((country) => {
                        const countryInfo = Object.values(localeToCountry).find(c => c.name === country);
                        return (
                            <button class="country-option" data-country={country}>
                                <span class="flag">{countryInfo?.flag}</span>
                                <span>{country}</span>
                            </button>
                        );
                    })}
                </div>
            </div>
        </div>

        <!-- Tab navigation -->
        <div class="tab-nav reveal">
            <button class="tab-btn active" data-tab="retail">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                {t.stores}
            </button>
            <button class="tab-btn" data-tab="foodservice">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                    <line x1="6" y1="1" x2="6" y2="4"/>
                    <line x1="10" y1="1" x2="10" y2="4"/>
                    <line x1="14" y1="1" x2="14" y2="4"/>
                </svg>
                {t.restaurants}
            </button>
            <button class="tab-btn" data-tab="delivery">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                {t.delivery}
            </button>
        </div>

        <!-- Retail partners tab -->
        <div class="tab-content active" id="retail-tab">
            <div class="partners-grid" id="retailGrid">
                {retailPartners.map((retailer) => {
                    const retailerCountries = getRetailerCountries(retailer);
                    const retailerProducts = (retailer.data.products || [])
                        .map(slug => productMap.get(slug))
                        .filter(Boolean)
                        .slice(0, 4);

                    return (
                        <a
                            href={retailer.data.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="partner-card reveal-scale"
                            data-countries={retailerCountries.join(',')}
                        >
                            <div class="card-header">
                                <div class="partner-logo">
                                    {retailer.data.logo ? (
                                        <img
                                            src={`${base}${retailer.data.logo}`}
                                            alt={retailer.data.name}
                                            loading="lazy"
                                        />
                                    ) : (
                                        <span class="partner-initial">{retailer.data.name.charAt(0)}</span>
                                    )}
                                </div>
                                <div class="partner-info">
                                    <h3 class="partner-name">{retailer.data.name}</h3>
                                    <div class="partner-countries">
                                        {retailerCountries.map((c: string) => (
                                            <span class="country-badge">{c}</span>
                                        ))}
                                    </div>
                                </div>
                                <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M7 17L17 7M17 7H7M17 7V17"/>
                                </svg>
                            </div>

                            {retailerProducts.length > 0 && (
                                <div class="products-preview">
                                    <span class="products-label">{t.availableProducts}</span>
                                    <div class="product-pills">
                                        {retailerProducts.map((product: any) => (
                                            <span class="product-pill">{product.name}</span>
                                        ))}
                                        {(retailer.data.products?.length || 0) > 4 && (
                                            <span class="product-pill more">+{(retailer.data.products?.length || 0) - 4}</span>
                                        )}
                                    </div>
                                </div>
                            )}
                        </a>
                    );
                })}
            </div>

            {retailPartners.length === 0 && (
                <p class="no-results">{t.noRetail}</p>
            )}
        </div>

        <!-- Foodservice partners tab -->
        <div class="tab-content" id="foodservice-tab">
            <div class="foodservice-intro reveal">
                <p>{t.foodserviceIntro}</p>
            </div>

            <div class="partners-grid foodservice-grid" id="foodserviceGrid">
                {foodservicePartners.map((partner) => {
                    const partnerCountries = getRetailerCountries(partner);

                    return (
                        <a
                            href={partner.data.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="partner-card foodservice-card reveal-scale"
                            data-countries={partnerCountries.join(',')}
                        >
                            <div class="card-header">
                                <div class="partner-logo">
                                    {partner.data.logo ? (
                                        <img
                                            src={`${base}${partner.data.logo}`}
                                            alt={partner.data.name}
                                            loading="lazy"
                                        />
                                    ) : (
                                        <span class="partner-initial">{partner.data.name.charAt(0)}</span>
                                    )}
                                </div>
                                <div class="partner-info">
                                    <h3 class="partner-name">{partner.data.name}</h3>
                                    <div class="partner-countries">
                                        {partnerCountries.map((c: string) => (
                                            <span class="country-badge">{c}</span>
                                        ))}
                                    </div>
                                </div>
                                <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M7 17L17 7M17 7H7M17 7V17"/>
                                </svg>
                            </div>

                            {partner.data.description && (
                                <p class="partner-description">{partner.data.description}</p>
                            )}
                        </a>
                    );
                })}
            </div>

            {foodservicePartners.length === 0 && (
                <p class="no-results">{t.noFoodservice}</p>
            )}
        </div>

        <!-- Delivery partners tab -->
        <div class="tab-content" id="delivery-tab">
            <div class="delivery-intro reveal">
                <p>{t.deliveryIntro}</p>
            </div>

            <div class="delivery-grid" id="deliveryGrid">
                {deliveryRestaurants.map((restaurant) => {
                    const countryName = deliveryCountryMap[restaurant.country] || restaurant.country;

                    return (
                        <div
                            class="delivery-card reveal-scale"
                            data-countries={countryName}
                        >
                            <div class="delivery-header">
                                <div class="restaurant-meta">
                                    <h3 class="restaurant-name">{restaurant.name}</h3>
                                    <div class="restaurant-info">
                                        <span class="restaurant-city">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                                <circle cx="12" cy="10" r="3"/>
                                            </svg>
                                            {restaurant.city}
                                        </span>
                                        <span class="restaurant-cuisine">{restaurant.cuisine}</span>
                                    </div>
                                </div>
                                {restaurant.rating && (
                                    <div class="restaurant-rating">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                        </svg>
                                        {restaurant.rating}
                                    </div>
                                )}
                            </div>

                            <div class="dish-menu">
                                {restaurant.dishes.slice(0, 3).map((dish) => (
                                    <div class="dish-item">
                                        <div class="dish-info">
                                            <div class="dish-name-row">
                                                <span class="dish-name">{dish.name}</span>
                                                {dish.isVegan && (
                                                    <span class="vegan-badge">{t.vegan}</span>
                                                )}
                                            </div>
                                            <p class="dish-description">{dish.description}</p>
                                        </div>
                                        {dish.price && (
                                            <span class="dish-price">{dish.price}</span>
                                        )}
                                    </div>
                                ))}
                            </div>

                            <div class="delivery-platforms">
                                {restaurant.deliveryPlatforms.map((platform) => (
                                    <a
                                        href={platform.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="platform-btn"
                                        style={`--platform-color: ${platformColors[platform.name]}`}
                                    >
                                        {platform.displayName}
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                            <polyline points="15 3 21 3 21 9"/>
                                            <line x1="10" y1="14" x2="21" y2="3"/>
                                        </svg>
                                    </a>
                                ))}
                            </div>
                        </div>
                    );
                })}
            </div>

            {deliveryRestaurants.length === 0 && (
                <p class="no-results">{t.noDelivery}</p>
            )}
        </div>

        <!-- Online shop CTA -->
        <div class="online-cta reveal">
            <div class="cta-content">
                <span class="cta-badge">{t.cantFind}</span>
                <span class="cta-text">{t.orderOnline}</span>
            </div>
            <a href="https://shop.eatplanted.com" class="btn btn-cta" target="_blank" rel="noopener">
                {t.shopOnline}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </a>
        </div>
    </div>

    <!-- Background decoration -->
    <div class="bg-pattern"></div>
</section>

<script define:vars={{ countryCodeToName, locale }}>
    function initStoreLocator() {
        const countryDetected = document.getElementById('countryDetected');
        const detectingEl = countryDetected?.querySelector('.detecting');
        const detectedEl = countryDetected?.querySelector('.detected');
        const countryFlag = document.getElementById('countryFlag');
        const countryName = document.getElementById('countryName');
        const changeCountryBtn = document.getElementById('changeCountry');
        const countrySelector = document.getElementById('countrySelector');
        const countryOptions = document.querySelectorAll('.country-option');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        let currentCountry = null;

        // Country flag mapping
        const countryFlags = {
            'Switzerland': 'ðŸ‡¨ðŸ‡­',
            'Germany': 'ðŸ‡©ðŸ‡ª',
            'Austria': 'ðŸ‡¦ðŸ‡¹',
            'Italy': 'ðŸ‡®ðŸ‡¹',
            'France': 'ðŸ‡«ðŸ‡·',
            'Netherlands': 'ðŸ‡³ðŸ‡±',
            'United Kingdom': 'ðŸ‡¬ðŸ‡§',
            'Spain': 'ðŸ‡ªðŸ‡¸'
        };

        // Map locale to country name
        const localeToCountryName = {
            'ch-de': 'Switzerland',
            'ch-fr': 'Switzerland',
            'ch-it': 'Switzerland',
            'ch-en': 'Switzerland',
            'de': 'Germany',
            'de-en': 'Germany',
            'at': 'Austria',
            'at-en': 'Austria',
            'it': 'Italy',
            'it-en': 'Italy',
            'fr': 'France',
            'fr-en': 'France',
            'nl': 'Netherlands',
            'nl-en': 'Netherlands',
            'uk': 'United Kingdom',
            'es': 'Spain',
            'es-en': 'Spain',
            'global': 'Switzerland' // Default for global
        };

        // Get country from page locale - no need for IP detection
        function getCountryFromLocale() {
            const currentLocale = locale;
            if (currentLocale && localeToCountryName[currentLocale]) {
                return localeToCountryName[currentLocale];
            }
            return 'Switzerland'; // Default fallback
        }

        // Initialize with locale-based country immediately
        function initCountry() {
            const countryFromLocale = getCountryFromLocale();
            setCountry(countryFromLocale);
        }

        // Set country and filter results
        function setCountry(country) {
            currentCountry = country;

            // Update UI
            if (detectingEl) detectingEl.style.display = 'none';
            if (detectedEl) detectedEl.style.display = 'flex';
            if (countryFlag) countryFlag.textContent = countryFlags[country] || 'ðŸŒ';
            if (countryName) countryName.textContent = country;
            if (countrySelector) countrySelector.style.display = 'none';

            // Filter partner cards
            filterCards(country);
        }

        // Filter cards by country
        function filterCards(country) {
            // Filter partner cards (retail & foodservice)
            const partnerCards = document.querySelectorAll('.partner-card');
            partnerCards.forEach((card) => {
                const cardCountries = card.dataset.countries?.split(',') || [];
                const matches = cardCountries.includes(country);

                if (matches) {
                    card.classList.remove('filtered-out');
                    card.style.display = '';
                } else {
                    card.classList.add('filtered-out');
                }
            });

            // Filter delivery cards
            const deliveryCards = document.querySelectorAll('.delivery-card');
            deliveryCards.forEach((card) => {
                const cardCountry = card.dataset.countries || '';
                const matches = cardCountry === country;

                if (matches) {
                    card.classList.remove('filtered-out');
                    card.style.display = '';
                } else {
                    card.classList.add('filtered-out');
                }
            });

            // Check if any cards are visible in each tab
            checkEmptyTabs();
        }

        // Check for empty tabs
        function checkEmptyTabs() {
            const retailCards = document.querySelectorAll('#retail-tab .partner-card:not(.filtered-out)');
            const foodserviceCards = document.querySelectorAll('#foodservice-tab .partner-card:not(.filtered-out)');
            const deliveryCards = document.querySelectorAll('#delivery-tab .delivery-card:not(.filtered-out)');

            // Update no results messages
            const retailTab = document.getElementById('retail-tab');
            const foodserviceTab = document.getElementById('foodservice-tab');
            const deliveryTab = document.getElementById('delivery-tab');

            let retailNoResults = retailTab?.querySelector('.no-results');
            let foodserviceNoResults = foodserviceTab?.querySelector('.no-results');
            let deliveryNoResults = deliveryTab?.querySelector('.no-results');

            if (retailCards.length === 0 && retailTab) {
                if (!retailNoResults) {
                    retailNoResults = document.createElement('p');
                    retailNoResults.className = 'no-results';
                    retailNoResults.textContent = 'No retail partners found in ' + currentCountry + '. Check out our online shop!';
                    retailTab.appendChild(retailNoResults);
                } else {
                    retailNoResults.style.display = '';
                }
            } else if (retailNoResults) {
                retailNoResults.style.display = 'none';
            }

            if (foodserviceCards.length === 0 && foodserviceTab) {
                if (!foodserviceNoResults) {
                    foodserviceNoResults = document.createElement('p');
                    foodserviceNoResults.className = 'no-results';
                    foodserviceNoResults.textContent = 'No restaurant partners in ' + currentCountry + ' yet. Stay tuned!';
                    foodserviceTab.appendChild(foodserviceNoResults);
                } else {
                    foodserviceNoResults.style.display = '';
                }
            } else if (foodserviceNoResults) {
                foodserviceNoResults.style.display = 'none';
            }

            if (deliveryCards.length === 0 && deliveryTab) {
                if (!deliveryNoResults) {
                    deliveryNoResults = document.createElement('p');
                    deliveryNoResults.className = 'no-results';
                    deliveryNoResults.textContent = 'No delivery partners in ' + currentCountry + ' yet. Check back soon!';
                    deliveryTab.appendChild(deliveryNoResults);
                } else {
                    deliveryNoResults.style.display = '';
                }
            } else if (deliveryNoResults) {
                deliveryNoResults.style.display = 'none';
            }
        }

        // Change country button
        changeCountryBtn?.addEventListener('click', () => {
            if (countrySelector) {
                countrySelector.style.display = countrySelector.style.display === 'none' ? 'block' : 'none';
            }
        });

        // Country option buttons
        countryOptions.forEach(option => {
            option.addEventListener('click', () => {
                const country = option.dataset.country;
                if (country) setCountry(country);
            });
        });

        // Tab switching
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;

                // Update button states
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update tab content visibility
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // Initialize with locale-based country (no IP detection needed)
        initCountry();
    }

    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initStoreLocator);
    } else {
        initStoreLocator();
    }

    // Re-init after View Transitions
    document.addEventListener('astro:page-load', initStoreLocator);
</script>

<style>
    .store-locator {
        background: var(--planted-purple);
        padding: 5rem 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .locator-inner {
        max-width: 1100px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }

    /* Header */
    .locator-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .locator-header h2 {
        font-size: clamp(2.5rem, 10vw, 4.5rem);
        color: white;
        margin-bottom: 0.5rem;
        line-height: 1;
    }

    .subtitle {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 1.5rem;
    }

    /* Country detection */
    .country-detected {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 100px;
        padding: 0.75rem 1.25rem;
        color: white;
        font-size: 0.95rem;
    }

    .detecting {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .detected {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .flag {
        font-size: 1.25rem;
    }

    .change-country {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 100px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        margin-left: 0.5rem;
    }

    .change-country:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Country selector */
    .country-selector {
        margin-top: 1rem;
    }

    .selector-inner {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
    }

    .country-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 100px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .country-option:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
    }

    /* Tab navigation */
    .tab-nav {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
    }

    .tab-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 100px;
        font-family: inherit;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .tab-btn svg {
        width: 20px;
        height: 20px;
    }

    .tab-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .tab-btn.active {
        background: var(--planted-green);
        border-color: var(--planted-green);
        color: var(--planted-purple);
    }

    /* Tab content */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .foodservice-intro {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        max-width: 600px;
        margin: 0 auto 2rem;
    }

    /* Partners grid */
    .partners-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 2.5rem;
    }

    .partner-card {
        background: white;
        border-radius: 1.25rem;
        padding: 1.25rem;
        text-decoration: none;
        color: var(--planted-charcoal);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s var(--ease-out-expo), box-shadow 0.3s;
    }

    .partner-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
    }

    /* Use :global() to prevent Astro from tree-shaking this class
       since it's added dynamically by JavaScript */
    :global(.partner-card.filtered-out) {
        display: none !important;
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .partner-logo {
        width: 60px;
        height: 60px;
        background: var(--planted-cream);
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        overflow: hidden;
    }

    .partner-logo img {
        max-width: 80%;
        max-height: 80%;
        object-fit: contain;
    }

    .partner-initial {
        font-family: 'VC Henrietta', serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--planted-purple);
    }

    .partner-info {
        flex: 1;
        min-width: 0;
    }

    .partner-name {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.35rem;
        color: var(--planted-charcoal);
    }

    .partner-countries {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .country-badge {
        background: var(--planted-cream);
        color: var(--planted-purple);
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.15rem 0.5rem;
        border-radius: 100px;
    }

    .arrow-icon {
        width: 18px;
        height: 18px;
        color: var(--planted-purple);
        opacity: 0;
        transform: translate(-4px, 4px);
        transition: all 0.3s;
        flex-shrink: 0;
    }

    .partner-card:hover .arrow-icon {
        opacity: 0.6;
        transform: translate(0, 0);
    }

    /* Products preview */
    .products-preview {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .products-label {
        display: block;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(0, 0, 0, 0.4);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .product-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
    }

    .product-pill {
        background: linear-gradient(135deg, var(--planted-purple), #8B3DB5);
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.25rem 0.6rem;
        border-radius: 100px;
    }

    .product-pill.more {
        background: var(--planted-green);
        color: var(--planted-purple);
    }

    /* Foodservice card specific */
    .foodservice-card .partner-description {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        font-size: 0.85rem;
        line-height: 1.5;
        color: rgba(0, 0, 0, 0.6);
    }

    /* Delivery tab styles */
    .delivery-intro {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        max-width: 600px;
        margin: 0 auto 2rem;
    }

    .delivery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2.5rem;
    }

    .delivery-card {
        background: white;
        border-radius: 1.25rem;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: transform 0.3s var(--ease-out-expo), box-shadow 0.3s;
    }

    .delivery-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
    }

    :global(.delivery-card.filtered-out) {
        display: none !important;
    }

    .delivery-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .restaurant-meta {
        flex: 1;
        min-width: 0;
    }

    .restaurant-name {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--planted-charcoal);
        margin: 0 0 0.35rem;
        line-height: 1.2;
    }

    .restaurant-info {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
    }

    .restaurant-city {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.85rem;
        color: #666;
    }

    .restaurant-city svg {
        width: 14px;
        height: 14px;
    }

    .restaurant-cuisine {
        font-size: 0.8rem;
        color: var(--planted-purple);
        background: rgba(107, 57, 131, 0.1);
        padding: 0.2rem 0.6rem;
        border-radius: 100px;
    }

    .restaurant-rating {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        background: #FFF8E1;
        color: #F59E0B;
        padding: 0.35rem 0.7rem;
        border-radius: 100px;
        font-size: 0.9rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .restaurant-rating svg {
        width: 14px;
        height: 14px;
    }

    /* Dish menu styles */
    .dish-menu {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem 0;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .dish-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .dish-info {
        flex: 1;
        min-width: 0;
    }

    .dish-name-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 0.25rem;
    }

    .dish-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--planted-charcoal);
    }

    .vegan-badge {
        background: linear-gradient(135deg, var(--planted-green), #7CB342);
        color: white;
        font-size: 0.65rem;
        font-weight: 700;
        padding: 0.15rem 0.5rem;
        border-radius: 100px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .dish-description {
        font-size: 0.8rem;
        color: #777;
        line-height: 1.4;
        margin: 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .dish-price {
        font-weight: 700;
        font-size: 0.95rem;
        color: var(--planted-green);
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Delivery platform buttons */
    .delivery-platforms {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .platform-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.6rem 1rem;
        background: var(--platform-color, #333);
        color: white;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .platform-btn:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
    }

    .platform-btn svg {
        width: 14px;
        height: 14px;
        opacity: 0.85;
    }

    /* No results */
    .no-results {
        text-align: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
        padding: 2rem;
    }

    /* Online CTA */
    .online-cta {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-radius: 1.25rem;
        padding: 1.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.25rem;
        text-align: center;
    }

    .cta-content {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .cta-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--planted-green);
        font-weight: 700;
    }

    .cta-text {
        color: white;
        font-size: 1rem;
    }

    .btn-cta {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--planted-green);
        color: var(--planted-purple);
        padding: 0.85rem 1.75rem;
        border-radius: 100px;
        font-weight: 700;
        text-decoration: none;
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .btn-cta:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(139, 197, 63, 0.4);
    }

    .btn-cta svg {
        width: 18px;
        height: 18px;
        transition: transform 0.3s;
    }

    .btn-cta:hover svg {
        transform: translateX(4px);
    }

    /* Background decoration */
    .bg-pattern {
        position: absolute;
        inset: 0;
        background-image:
            radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.03) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(139, 197, 63, 0.05) 0%, transparent 40%);
        pointer-events: none;
    }

    /* Responsive */
    @media (min-width: 640px) {
        .partners-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .online-cta {
            flex-direction: row;
            justify-content: space-between;
            text-align: left;
        }
    }

    @media (min-width: 768px) {
        .partners-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }
    }

    @media (min-width: 1024px) {
        .store-locator {
            padding: 6rem 3rem;
        }

        .partners-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (min-width: 1440px) {
        .store-locator {
            padding: 7rem 5rem;
        }

        .locator-inner {
            max-width: 1300px;
        }
    }
</style>
