---
import { getCollection } from 'astro:content';
import { deliveryRestaurants, platformColors, type DeliveryRestaurant } from '../data/deliveryRestaurants';
import { chainLocations, chains, chainPlatformColors, type ChainLocation, type Chain } from '../data/chainRestaurants';

interface Translations {
    detecting?: string;
    showingResults?: string;
    change?: string;
    stores?: string;
    restaurants?: string;
    delivery?: string;
    noRetail?: string;
    noFoodservice?: string;
    noDelivery?: string;
    foodserviceIntro?: string;
    deliveryIntro?: string;
    availableProducts?: string;
    orderNow?: string;
    viewMenu?: string;
    vegan?: string;
    cantFind?: string;
    orderOnline?: string;
    shopOnline?: string;
    zipPlaceholder?: string;
    zipLabel?: string;
    findNearest?: string;
    nearYou?: string;
    locations?: string;
}

interface Props {
    title?: string;
    subtitle?: string;
    translations?: Translations;
    locale?: string;
}

const {
    title = "Find Us",
    subtitle = "Discover where to get your planted fix.",
    translations = {},
    locale
} = Astro.props;

// Default English translations
const t = {
    detecting: translations.detecting || "Finding your location...",
    showingResults: translations.showingResults || "Showing results for",
    change: translations.change || "Change",
    stores: translations.stores || "Stores",
    restaurants: translations.restaurants || "Restaurants",
    delivery: translations.delivery || "Delivery",
    noRetail: translations.noRetail || "No retail partners found in your area.",
    noFoodservice: translations.noFoodservice || "No restaurant partners yet. Stay tuned!",
    noDelivery: translations.noDelivery || "No delivery partners in your area yet.",
    foodserviceIntro: translations.foodserviceIntro || "We're proud to partner with restaurants and foodservice providers who share our passion for delicious, sustainable food.",
    deliveryIntro: translations.deliveryIntro || "Order planted dishes directly to your door from these partner restaurants.",
    availableProducts: translations.availableProducts || "Available products:",
    orderNow: translations.orderNow || "Order now",
    viewMenu: translations.viewMenu || "View menu",
    vegan: translations.vegan || "Vegan",
    cantFind: translations.cantFind || "Can't find a store?",
    orderOnline: translations.orderOnline || "Order directly from our online shop and get planted delivered to your door.",
    shopOnline: translations.shopOnline || "Shop Online",
    zipPlaceholder: translations.zipPlaceholder || "ZIP code",
    zipLabel: translations.zipLabel || "Enter ZIP for nearest location",
    findNearest: translations.findNearest || "Find nearest",
    nearYou: translations.nearYou || "near you",
    locations: translations.locations || "locations",
};

// ZIP code placeholders by country
const zipPlaceholders: Record<string, string> = {
    'Switzerland': '8001',
    'Germany': '10115',
    'Austria': '1010',
    'Luxembourg': '1111',
    'Italy': '20121',
    'France': '75001',
    'Netherlands': '1011',
    'United Kingdom': 'SW1A 1AA',
    'Spain': '28001',
};

// Pass chain data to client
const chainDataForClient = JSON.stringify(chainLocations);
const chainsMetaForClient = JSON.stringify(chains);

const base = import.meta.env.BASE_URL;

// Get retailer and product data
const retailers = await getCollection('retailers');
const products = await getCollection('products');

// Create product lookup map
const productMap = new Map(products.map(p => [p.id, p.data]));

// Map locale codes to country info
const localeToCountry: Record<string, { name: string; code: string; flag: string }> = {
    'ch-de': { name: 'Switzerland', code: 'CH', flag: 'ðŸ‡¨ðŸ‡­' },
    'ch-fr': { name: 'Switzerland', code: 'CH', flag: 'ðŸ‡¨ðŸ‡­' },
    'ch-it': { name: 'Switzerland', code: 'CH', flag: 'ðŸ‡¨ðŸ‡­' },
    'de': { name: 'Germany', code: 'DE', flag: 'ðŸ‡©ðŸ‡ª' },
    'at': { name: 'Austria', code: 'AT', flag: 'ðŸ‡¦ðŸ‡¹' },
    'it': { name: 'Italy', code: 'IT', flag: 'ðŸ‡®ðŸ‡¹' },
    'fr': { name: 'France', code: 'FR', flag: 'ðŸ‡«ðŸ‡·' },
    'nl': { name: 'Netherlands', code: 'NL', flag: 'ðŸ‡³ðŸ‡±' },
    'uk': { name: 'United Kingdom', code: 'GB', flag: 'ðŸ‡¬ðŸ‡§' },
    'es': { name: 'Spain', code: 'ES', flag: 'ðŸ‡ªðŸ‡¸' }
};

// Country code to name mapping for IP detection
const countryCodeToName: Record<string, string> = {
    'CH': 'Switzerland',
    'DE': 'Germany',
    'AT': 'Austria',
    'IT': 'Italy',
    'FR': 'France',
    'NL': 'Netherlands',
    'GB': 'United Kingdom',
    'ES': 'Spain'
};

// Group retailers by type
const retailPartners = retailers.filter(r => r.data.type !== 'foodservice').sort((a, b) => (a.data.order || 99) - (b.data.order || 99));
const foodservicePartners = retailers.filter(r => r.data.type === 'foodservice').sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

// Get unique countries from all retailers
const allCountries = new Set<string>();
retailers.forEach(r => {
    r.data.countries.forEach(locale => {
        const country = localeToCountry[locale];
        if (country) allCountries.add(country.name);
    });
});
const countries = Array.from(allCountries).sort();

// Country code to full name for delivery restaurants
const deliveryCountryMap: Record<string, string> = {
    'ch': 'Switzerland',
    'de': 'Germany',
    'at': 'Austria',
    'nl': 'Netherlands',
    'uk': 'United Kingdom',
    'fr': 'France',
    'it': 'Italy',
    'es': 'Spain'
};

// Helper to get country name from locale
function getCountryName(locale: string): string {
    return localeToCountry[locale]?.name || locale;
}

// Helper to get countries for retailer
function getRetailerCountries(retailer: typeof retailers[0]): string[] {
    const countrySet = new Set<string>();
    retailer.data.countries.forEach(locale => {
        const country = localeToCountry[locale];
        if (country) countrySet.add(country.name);
    });
    return Array.from(countrySet);
}
---

<section class="store-locator" id="locator">
    <div class="locator-inner">
        <!-- Header with country detection -->
        <div class="locator-header reveal">
            <h2>{title}</h2>
            <p class="subtitle">{subtitle}</p>

            <!-- Detected country display -->
            <div class="country-detected" id="countryDetected">
                <div class="detecting">
                    <span class="spinner"></span>
                    <span>{t.detecting}</span>
                </div>
                <div class="detected" style="display: none;">
                    <span class="flag" id="countryFlag"></span>
                    <span>{t.showingResults} <strong id="countryName"></strong></span>
                    <button class="change-country" id="changeCountry">{t.change}</button>
                </div>
            </div>

            <!-- Country selector (hidden by default, shown when changing) -->
            <div class="country-selector" id="countrySelector" style="display: none;">
                <div class="selector-inner">
                    {countries.map((country) => {
                        const countryInfo = Object.values(localeToCountry).find(c => c.name === country);
                        return (
                            <button class="country-option" data-country={country}>
                                <span class="flag">{countryInfo?.flag}</span>
                                <span>{country}</span>
                            </button>
                        );
                    })}
                </div>
            </div>

            <!-- ZIP Code Input -->
            <div class="zip-input-wrapper reveal" id="zipInputWrapper">
                <div class="zip-input-container">
                    <div class="zip-input-inner">
                        <svg class="zip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        <input
                            type="text"
                            id="zipInput"
                            class="zip-input"
                            placeholder="8001"
                            autocomplete="postal-code"
                            data-placeholders={JSON.stringify(zipPlaceholders)}
                        />
                        <button class="zip-search-btn" id="zipSearchBtn" aria-label={t.findNearest}>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                    <span class="zip-hint" id="zipHint">{t.zipLabel}</span>
                </div>
                <div class="zip-loading" id="zipLoading" style="display: none;">
                    <span class="spinner"></span>
                    <span>Finding nearest...</span>
                </div>
                <div class="zip-result" id="zipResult" style="display: none;">
                    <span class="zip-result-text"></span>
                    <button class="zip-clear-btn" id="zipClearBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab navigation -->
        <div class="tab-nav reveal">
            <button class="tab-btn active" data-tab="retail">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                {t.stores}
            </button>
            <button class="tab-btn" data-tab="foodservice">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"/>
                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/>
                    <line x1="6" y1="1" x2="6" y2="4"/>
                    <line x1="10" y1="1" x2="10" y2="4"/>
                    <line x1="14" y1="1" x2="14" y2="4"/>
                </svg>
                {t.restaurants}
            </button>
            <button class="tab-btn" data-tab="delivery">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                {t.delivery}
            </button>
        </div>

        <!-- Retail partners tab -->
        <div class="tab-content active" id="retail-tab">
            <div class="partners-grid" id="retailGrid">
                {retailPartners.map((retailer) => {
                    const retailerCountries = getRetailerCountries(retailer);
                    const retailerProducts = (retailer.data.products || [])
                        .map(slug => productMap.get(slug))
                        .filter(Boolean)
                        .slice(0, 4);

                    return (
                        <a
                            href={retailer.data.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="partner-card reveal-scale"
                            data-countries={retailerCountries.join(',')}
                        >
                            <div class="card-header">
                                <div class="partner-logo">
                                    {retailer.data.logo ? (
                                        <img
                                            src={`${base}${retailer.data.logo}`}
                                            alt={retailer.data.name}
                                            loading="lazy"
                                        />
                                    ) : (
                                        <span class="partner-initial">{retailer.data.name.charAt(0)}</span>
                                    )}
                                </div>
                                <div class="partner-info">
                                    <h3 class="partner-name">{retailer.data.name}</h3>
                                    <div class="partner-countries">
                                        {retailerCountries.map((c: string) => (
                                            <span class="country-badge">{c}</span>
                                        ))}
                                    </div>
                                </div>
                                <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M7 17L17 7M17 7H7M17 7V17"/>
                                </svg>
                            </div>

                            {retailerProducts.length > 0 && (
                                <div class="products-preview">
                                    <span class="products-label">{t.availableProducts}</span>
                                    <div class="product-pills">
                                        {retailerProducts.map((product: any) => (
                                            <span class="product-pill">{product.name}</span>
                                        ))}
                                        {(retailer.data.products?.length || 0) > 4 && (
                                            <span class="product-pill more">+{(retailer.data.products?.length || 0) - 4}</span>
                                        )}
                                    </div>
                                </div>
                            )}
                        </a>
                    );
                })}
            </div>

            {retailPartners.length === 0 && (
                <p class="no-results">{t.noRetail}</p>
            )}
        </div>

        <!-- Foodservice partners tab -->
        <div class="tab-content" id="foodservice-tab">
            <div class="foodservice-intro reveal">
                <p>{t.foodserviceIntro}</p>
            </div>

            <div class="partners-grid foodservice-grid" id="foodserviceGrid">
                {foodservicePartners.map((partner) => {
                    const partnerCountries = getRetailerCountries(partner);

                    return (
                        <a
                            href={partner.data.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="partner-card foodservice-card reveal-scale"
                            data-countries={partnerCountries.join(',')}
                        >
                            <div class="card-header">
                                <div class="partner-logo">
                                    {partner.data.logo ? (
                                        <img
                                            src={`${base}${partner.data.logo}`}
                                            alt={partner.data.name}
                                            loading="lazy"
                                        />
                                    ) : (
                                        <span class="partner-initial">{partner.data.name.charAt(0)}</span>
                                    )}
                                </div>
                                <div class="partner-info">
                                    <h3 class="partner-name">{partner.data.name}</h3>
                                    <div class="partner-countries">
                                        {partnerCountries.map((c: string) => (
                                            <span class="country-badge">{c}</span>
                                        ))}
                                    </div>
                                </div>
                                <svg class="arrow-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M7 17L17 7M17 7H7M17 7V17"/>
                                </svg>
                            </div>

                            {partner.data.description && (
                                <p class="partner-description">{partner.data.description}</p>
                            )}
                        </a>
                    );
                })}
            </div>

            {foodservicePartners.length === 0 && (
                <p class="no-results">{t.noFoodservice}</p>
            )}
        </div>

        <!-- Delivery partners tab -->
        <div class="tab-content" id="delivery-tab">
            <div class="delivery-intro reveal">
                <p>{t.deliveryIntro}</p>
            </div>

            <!-- Chain restaurants grid (populated by JS based on ZIP) -->
            <div class="chain-grid" id="chainGrid">
                {chains.map((chain) => {
                    // Get first location for this chain as default
                    const defaultLocation = chainLocations.find(loc => loc.chainId === chain.id);
                    const codeToName = { 'DE': 'Germany', 'CH': 'Switzerland', 'AT': 'Austria', 'LU': 'Luxembourg' };

                    return defaultLocation && (
                        <div
                            class="chain-card reveal-scale"
                            data-chain-id={chain.id}
                            data-countries={chain.countries.map(c => codeToName[c as keyof typeof codeToName] || c).join(',')}
                            data-location-id={defaultLocation.id}
                        >
                            <div class="chain-header">
                                <div class="chain-meta">
                                    <div class="chain-name-row">
                                        <h3 class="chain-name">{chain.name}</h3>
                                        <span class="chain-locations-badge" title={`${chain.totalLocations} ${t.locations}`}>
                                            {chain.totalLocations}
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                                <circle cx="12" cy="10" r="3"/>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="chain-info">
                                        <span class="chain-location" data-location-name={defaultLocation.name}>
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                                <circle cx="12" cy="10" r="3"/>
                                            </svg>
                                            <span class="location-text">{defaultLocation.city}</span>
                                        </span>
                                        <span class="chain-cuisine">{chain.cuisine}</span>
                                    </div>
                                </div>
                                <div class="distance-badge" style="display: none;">
                                    <span class="distance-value"></span>
                                </div>
                            </div>

                            {defaultLocation.dishes && defaultLocation.dishes.length > 0 && (
                                <div class="dish-menu">
                                    {defaultLocation.dishes.slice(0, 2).map((dish) => (
                                        <div class="dish-item">
                                            <div class="dish-info">
                                                <div class="dish-name-row">
                                                    <span class="dish-name">{dish.name}</span>
                                                    {dish.isVegan && (
                                                        <span class="vegan-badge">{t.vegan}</span>
                                                    )}
                                                </div>
                                                <p class="dish-description">{dish.description}</p>
                                            </div>
                                            {dish.price && (
                                                <span class="dish-price">{dish.price}</span>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div class="chain-products">
                                {chain.plantedProducts.map((product) => (
                                    <span class="product-tag">{product}</span>
                                ))}
                            </div>

                            <div class="delivery-platforms chain-platforms" data-platforms={JSON.stringify(defaultLocation.deliveryPlatforms)}>
                                {defaultLocation.deliveryPlatforms.slice(0, 3).map((platform) => (
                                    <a
                                        href={platform.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="platform-btn"
                                        style={`--platform-color: ${chainPlatformColors[platform.name] || '#333'}`}
                                    >
                                        {platform.displayName}
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                            <polyline points="15 3 21 3 21 9"/>
                                            <line x1="10" y1="14" x2="21" y2="3"/>
                                        </svg>
                                    </a>
                                ))}
                            </div>
                        </div>
                    );
                })}
            </div>

            <!-- Legacy delivery restaurants (for backwards compatibility) -->
            <div class="delivery-grid" id="deliveryGrid" style="display: none;">
                {deliveryRestaurants.map((restaurant) => {
                    const countryName = deliveryCountryMap[restaurant.country] || restaurant.country;

                    return (
                        <div
                            class="delivery-card reveal-scale"
                            data-countries={countryName}
                        >
                            <div class="delivery-header">
                                <div class="restaurant-meta">
                                    <h3 class="restaurant-name">{restaurant.name}</h3>
                                    <div class="restaurant-info">
                                        <span class="restaurant-city">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                                <circle cx="12" cy="10" r="3"/>
                                            </svg>
                                            {restaurant.city}
                                        </span>
                                        <span class="restaurant-cuisine">{restaurant.cuisine}</span>
                                    </div>
                                </div>
                                {restaurant.rating && (
                                    <div class="restaurant-rating">
                                        <svg viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                        </svg>
                                        {restaurant.rating}
                                    </div>
                                )}
                            </div>

                            <div class="dish-menu">
                                {restaurant.dishes.slice(0, 3).map((dish) => (
                                    <div class="dish-item">
                                        <div class="dish-info">
                                            <div class="dish-name-row">
                                                <span class="dish-name">{dish.name}</span>
                                                {dish.isVegan && (
                                                    <span class="vegan-badge">{t.vegan}</span>
                                                )}
                                            </div>
                                            <p class="dish-description">{dish.description}</p>
                                        </div>
                                        {dish.price && (
                                            <span class="dish-price">{dish.price}</span>
                                        )}
                                    </div>
                                ))}
                            </div>

                            <div class="delivery-platforms">
                                {restaurant.deliveryPlatforms.map((platform) => (
                                    <a
                                        href={platform.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="platform-btn"
                                        style={`--platform-color: ${platformColors[platform.name]}`}
                                    >
                                        {platform.displayName}
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                            <polyline points="15 3 21 3 21 9"/>
                                            <line x1="10" y1="14" x2="21" y2="3"/>
                                        </svg>
                                    </a>
                                ))}
                            </div>
                        </div>
                    );
                })}
            </div>

            {chains.length === 0 && deliveryRestaurants.length === 0 && (
                <p class="no-results">{t.noDelivery}</p>
            )}
        </div>

        <!-- Online shop CTA -->
        <div class="online-cta reveal">
            <div class="cta-content">
                <span class="cta-badge">{t.cantFind}</span>
                <span class="cta-text">{t.orderOnline}</span>
            </div>
            <a href="https://shop.eatplanted.com" class="btn btn-cta" target="_blank" rel="noopener">
                {t.shopOnline}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </a>
        </div>
    </div>

    <!-- Background decoration -->
    <div class="bg-pattern"></div>
</section>

<script define:vars={{ countryCodeToName, locale, chainDataForClient, chainsMetaForClient }}>
    function initStoreLocator() {
        const countryDetected = document.getElementById('countryDetected');
        const detectingEl = countryDetected?.querySelector('.detecting');
        const detectedEl = countryDetected?.querySelector('.detected');
        const countryFlag = document.getElementById('countryFlag');
        const countryName = document.getElementById('countryName');
        const changeCountryBtn = document.getElementById('changeCountry');
        const countrySelector = document.getElementById('countrySelector');
        const countryOptions = document.querySelectorAll('.country-option');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        // ZIP code elements
        const zipInput = document.getElementById('zipInput');
        const zipSearchBtn = document.getElementById('zipSearchBtn');
        const zipLoading = document.getElementById('zipLoading');
        const zipResult = document.getElementById('zipResult');
        const zipHint = document.getElementById('zipHint');
        const zipClearBtn = document.getElementById('zipClearBtn');
        const zipInputContainer = document.querySelector('.zip-input-container');

        // Parse chain data from server
        const chainLocations = JSON.parse(chainDataForClient);
        const chainsMeta = JSON.parse(chainsMetaForClient);

        let currentCountry = null;
        let currentCoords = null; // { lat, lng } when ZIP is searched

        // Country flag mapping
        const countryFlags = {
            'Switzerland': 'ðŸ‡¨ðŸ‡­',
            'Germany': 'ðŸ‡©ðŸ‡ª',
            'Austria': 'ðŸ‡¦ðŸ‡¹',
            'Italy': 'ðŸ‡®ðŸ‡¹',
            'France': 'ðŸ‡«ðŸ‡·',
            'Netherlands': 'ðŸ‡³ðŸ‡±',
            'United Kingdom': 'ðŸ‡¬ðŸ‡§',
            'Spain': 'ðŸ‡ªðŸ‡¸'
        };

        // Map locale to country name
        const localeToCountryName = {
            'ch-de': 'Switzerland',
            'ch-fr': 'Switzerland',
            'ch-it': 'Switzerland',
            'ch-en': 'Switzerland',
            'de': 'Germany',
            'de-en': 'Germany',
            'at': 'Austria',
            'at-en': 'Austria',
            'it': 'Italy',
            'it-en': 'Italy',
            'fr': 'France',
            'fr-en': 'France',
            'nl': 'Netherlands',
            'nl-en': 'Netherlands',
            'uk': 'United Kingdom',
            'es': 'Spain',
            'es-en': 'Spain',
            'global': 'Switzerland' // Default for global
        };

        // Get country from page locale - no need for IP detection
        function getCountryFromLocale() {
            const currentLocale = locale;
            if (currentLocale && localeToCountryName[currentLocale]) {
                return localeToCountryName[currentLocale];
            }
            return 'Switzerland'; // Default fallback
        }

        // Initialize with locale-based country immediately
        function initCountry() {
            const countryFromLocale = getCountryFromLocale();
            setCountry(countryFromLocale);
        }

        // Set country and filter results
        function setCountry(country) {
            currentCountry = country;

            // Update UI
            if (detectingEl) detectingEl.style.display = 'none';
            if (detectedEl) detectedEl.style.display = 'flex';
            if (countryFlag) countryFlag.textContent = countryFlags[country] || 'ðŸŒ';
            if (countryName) countryName.textContent = country;
            if (countrySelector) countrySelector.style.display = 'none';

            // Update ZIP placeholder for this country
            updateZipPlaceholder(country);

            // Clear any existing ZIP search when changing country
            clearZipSearch();

            // Filter partner cards
            filterCards(country);
        }

        // Filter cards by country
        function filterCards(country) {
            // Filter partner cards (retail & foodservice)
            const partnerCards = document.querySelectorAll('.partner-card');
            partnerCards.forEach((card) => {
                const cardCountries = card.dataset.countries?.split(',') || [];
                const matches = cardCountries.includes(country);

                if (matches) {
                    card.classList.remove('filtered-out');
                    card.style.display = '';
                } else {
                    card.classList.add('filtered-out');
                }
            });

            // Filter chain cards
            const chainCards = document.querySelectorAll('.chain-card');
            chainCards.forEach((card) => {
                const cardCountries = card.dataset.countries?.split(',') || [];
                const matches = cardCountries.includes(country);

                if (matches) {
                    card.classList.remove('filtered-out');
                    card.style.display = '';
                } else {
                    card.classList.add('filtered-out');
                }
            });

            // Filter legacy delivery cards
            const deliveryCards = document.querySelectorAll('.delivery-card');
            deliveryCards.forEach((card) => {
                const cardCountry = card.dataset.countries || '';
                const matches = cardCountry === country;

                if (matches) {
                    card.classList.remove('filtered-out');
                    card.style.display = '';
                } else {
                    card.classList.add('filtered-out');
                }
            });

            // Check if any cards are visible in each tab
            checkEmptyTabs();
        }

        // ============================================
        // ZIP CODE & DISTANCE FUNCTIONS
        // ============================================

        // Haversine distance calculation
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function toRad(deg) {
            return deg * (Math.PI / 180);
        }

        function formatDistance(km) {
            if (km < 1) return Math.round(km * 1000) + 'm';
            if (km < 10) return km.toFixed(1) + 'km';
            return Math.round(km) + 'km';
        }

        // Get country code for geocoding
        function getCountryCodeForGeocoding(countryName) {
            const map = {
                'Switzerland': 'ch',
                'Germany': 'de',
                'Austria': 'at',
                'Luxembourg': 'lu',
                'Italy': 'it',
                'France': 'fr',
                'Netherlands': 'nl',
                'United Kingdom': 'gb',
                'Spain': 'es'
            };
            return map[countryName] || 'de';
        }

        // Geocode ZIP code using Nominatim (OSM)
        async function geocodeZip(zip, countryCode) {
            // Check cache first
            const cacheKey = `geo_${zip}_${countryCode}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                const data = JSON.parse(cached);
                if (Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000) { // 7 days
                    return data.coords;
                }
            }

            try {
                const url = `https://nominatim.openstreetmap.org/search?postalcode=${encodeURIComponent(zip)}&country=${countryCode}&format=json&limit=1`;
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'PlantedWebsite/1.0' }
                });

                if (!response.ok) throw new Error('Geocoding failed');

                const data = await response.json();
                if (data.length === 0) throw new Error('ZIP not found');

                const coords = {
                    lat: parseFloat(data[0].lat),
                    lng: parseFloat(data[0].lon),
                    displayName: data[0].display_name.split(',')[0]
                };

                // Cache result
                localStorage.setItem(cacheKey, JSON.stringify({
                    coords,
                    timestamp: Date.now()
                }));

                return coords;
            } catch (error) {
                console.error('Geocoding error:', error);
                throw error;
            }
        }

        // Get delivery radius for a chain
        function getDeliveryRadius(chainId) {
            const chain = chainsMeta.find(c => c.id === chainId);
            return chain?.deliveryRadiusKm || 8; // Default 8km
        }

        // Get chains that CAN DELIVER to this location (within delivery radius)
        function getDeliverableChainLocations(lat, lng, country) {
            const countryCodeMap = {
                'Switzerland': 'ch',
                'Germany': 'de',
                'Austria': 'at',
                'Luxembourg': 'lu'
            };
            const countryCode = countryCodeMap[country];

            // Filter by country
            const filtered = chainLocations.filter(loc => loc.country === countryCode);

            // Calculate distances
            const withDistance = filtered.map(loc => ({
                ...loc,
                distance: calculateDistance(lat, lng, loc.coordinates.lat, loc.coordinates.lng)
            }));

            // Group by chain and get closest for each
            const chainMap = new Map();
            for (const loc of withDistance) {
                const existing = chainMap.get(loc.chainId);
                if (!existing || loc.distance < existing.distance) {
                    chainMap.set(loc.chainId, loc);
                }
            }

            // CRITICAL: Filter to only chains that can actually deliver
            // (closest location must be within delivery radius)
            const deliverable = [];
            for (const [chainId, loc] of chainMap) {
                const deliveryRadius = getDeliveryRadius(chainId);
                if (loc.distance <= deliveryRadius) {
                    deliverable.push(loc);
                }
            }

            // Sort by distance
            return deliverable.sort((a, b) => a.distance - b.distance);
        }

        // Update chain cards with distances
        function updateChainCardsWithDistance(closestLocations) {
            const chainCards = document.querySelectorAll('.chain-card');

            chainCards.forEach(card => {
                const chainId = card.dataset.chainId;
                const closestLoc = closestLocations.find(loc => loc.chainId === chainId);

                if (closestLoc) {
                    // Show distance badge
                    const distanceBadge = card.querySelector('.distance-badge');
                    const distanceValue = card.querySelector('.distance-value');
                    if (distanceBadge && distanceValue) {
                        distanceValue.textContent = formatDistance(closestLoc.distance);
                        distanceBadge.style.display = 'flex';
                        distanceBadge.classList.add('animate-in');
                    }

                    // Update location text
                    const locationText = card.querySelector('.location-text');
                    if (locationText) {
                        locationText.textContent = closestLoc.city;
                    }

                    // Update delivery platforms if different location
                    const platformsContainer = card.querySelector('.chain-platforms');
                    if (platformsContainer && closestLoc.deliveryPlatforms?.length > 0) {
                        const platformColors = {
                            'wolt': '#00C2E8',
                            'lieferando': '#FF8000',
                            'uber-eats': '#06C167',
                            'just-eat': '#FF5A00',
                            'smood': '#E91E63'
                        };

                        platformsContainer.innerHTML = closestLoc.deliveryPlatforms.slice(0, 3).map(p => `
                            <a href="${p.url}" target="_blank" rel="noopener noreferrer"
                               class="platform-btn" style="--platform-color: ${platformColors[p.name] || '#333'}">
                                ${p.displayName}
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                    <polyline points="15 3 21 3 21 9"/>
                                    <line x1="10" y1="14" x2="21" y2="3"/>
                                </svg>
                            </a>
                        `).join('');
                    }

                    // Store distance for sorting
                    card.dataset.distance = closestLoc.distance;
                    card.classList.remove('filtered-out');
                } else {
                    card.classList.add('filtered-out');
                }
            });

            // Sort cards by distance
            sortChainCardsByDistance();
        }

        // Sort chain cards by distance
        function sortChainCardsByDistance() {
            const grid = document.getElementById('chainGrid');
            if (!grid) return;

            const cards = Array.from(grid.querySelectorAll('.chain-card:not(.filtered-out)'));
            cards.sort((a, b) => {
                const distA = parseFloat(a.dataset.distance) || 9999;
                const distB = parseFloat(b.dataset.distance) || 9999;
                return distA - distB;
            });

            // Reorder DOM
            cards.forEach((card, index) => {
                card.style.order = index;
                // Stagger animation
                card.style.animationDelay = `${index * 50}ms`;
            });
        }

        // Clear distance badges
        function clearDistanceBadges() {
            const badges = document.querySelectorAll('.distance-badge');
            badges.forEach(badge => {
                badge.style.display = 'none';
                badge.classList.remove('animate-in');
            });

            // Reset card order
            const cards = document.querySelectorAll('.chain-card');
            cards.forEach(card => {
                card.style.order = '';
                card.style.animationDelay = '';
                delete card.dataset.distance;
            });
        }

        // Handle ZIP search
        async function handleZipSearch() {
            const zip = zipInput?.value?.trim();
            if (!zip || zip.length < 3) return;

            const countryCode = getCountryCodeForGeocoding(currentCountry);

            // Show loading
            if (zipInputContainer) zipInputContainer.style.display = 'none';
            if (zipLoading) zipLoading.style.display = 'flex';
            if (zipResult) zipResult.style.display = 'none';

            // Hide any existing no-delivery message
            const existingNoDelivery = document.getElementById('noDeliveryMessage');
            if (existingNoDelivery) existingNoDelivery.style.display = 'none';

            try {
                const coords = await geocodeZip(zip, countryCode);
                currentCoords = coords;

                // Get DELIVERABLE locations (within delivery radius)
                const deliverable = getDeliverableChainLocations(coords.lat, coords.lng, currentCountry);
                updateChainCardsWithDistance(deliverable);

                // Show result
                if (zipLoading) zipLoading.style.display = 'none';

                if (deliverable.length > 0) {
                    // Found restaurants that can deliver
                    if (zipResult) {
                        zipResult.style.display = 'flex';
                        const resultText = zipResult.querySelector('.zip-result-text');
                        if (resultText) {
                            resultText.textContent = `${deliverable.length} restaurant${deliverable.length > 1 ? 's' : ''} deliver to ${coords.displayName || zip}`;
                        }
                    }
                } else {
                    // NO restaurants can deliver to this location
                    if (zipResult) {
                        zipResult.style.display = 'flex';
                        zipResult.classList.add('no-delivery');
                        const resultText = zipResult.querySelector('.zip-result-text');
                        if (resultText) {
                            resultText.textContent = `No delivery to ${coords.displayName || zip}`;
                        }
                    }

                    // Show helpful no-delivery message
                    showNoDeliveryMessage(coords.displayName || zip);
                }

                // Switch to delivery tab to show results
                const deliveryTab = document.querySelector('[data-tab="delivery"]');
                if (deliveryTab) deliveryTab.click();

            } catch (error) {
                // Show error / reset
                if (zipLoading) zipLoading.style.display = 'none';
                if (zipInputContainer) zipInputContainer.style.display = 'block';
                if (zipHint) {
                    zipHint.textContent = 'ZIP code not found. Try another.';
                    zipHint.classList.add('error');
                    setTimeout(() => {
                        zipHint.textContent = 'Enter ZIP for nearest location';
                        zipHint.classList.remove('error');
                    }, 3000);
                }
            }
        }

        // Show no delivery available message with alternatives
        function showNoDeliveryMessage(location) {
            const chainGrid = document.getElementById('chainGrid');
            if (!chainGrid) return;

            // Check if message already exists
            let noDeliveryMsg = document.getElementById('noDeliveryMessage');
            if (!noDeliveryMsg) {
                noDeliveryMsg = document.createElement('div');
                noDeliveryMsg.id = 'noDeliveryMessage';
                noDeliveryMsg.className = 'no-delivery-message';
                chainGrid.parentNode.insertBefore(noDeliveryMsg, chainGrid);
            }

            noDeliveryMsg.innerHTML = `
                <div class="no-delivery-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                </div>
                <h3>No delivery partners in ${location} yet</h3>
                <p>Our delivery partners don't currently cover this area. But you can still get planted!</p>
                <div class="no-delivery-alternatives">
                    <button class="alt-btn" onclick="document.querySelector('[data-tab=retail]')?.click()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                        Find retail stores
                    </button>
                    <a href="https://shop.eatplanted.com" target="_blank" rel="noopener" class="alt-btn alt-btn-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                        </svg>
                        Order online
                    </a>
                </div>
            `;
            noDeliveryMsg.style.display = 'block';
        }

        // Clear ZIP search
        function clearZipSearch() {
            currentCoords = null;
            if (zipInput) zipInput.value = '';
            if (zipInputContainer) zipInputContainer.style.display = 'block';
            if (zipResult) {
                zipResult.style.display = 'none';
                zipResult.classList.remove('no-delivery');
            }
            if (zipLoading) zipLoading.style.display = 'none';

            // Hide no-delivery message
            const noDeliveryMsg = document.getElementById('noDeliveryMessage');
            if (noDeliveryMsg) noDeliveryMsg.style.display = 'none';

            clearDistanceBadges();
            filterCards(currentCountry);
        }

        // Update ZIP placeholder based on country
        function updateZipPlaceholder(country) {
            if (!zipInput) return;
            const placeholders = JSON.parse(zipInput.dataset.placeholders || '{}');
            zipInput.placeholder = placeholders[country] || '10115';
        }

        // Check for empty tabs
        function checkEmptyTabs() {
            const retailCards = document.querySelectorAll('#retail-tab .partner-card:not(.filtered-out)');
            const foodserviceCards = document.querySelectorAll('#foodservice-tab .partner-card:not(.filtered-out)');
            const chainCards = document.querySelectorAll('#delivery-tab .chain-card:not(.filtered-out)');
            const deliveryCards = document.querySelectorAll('#delivery-tab .delivery-card:not(.filtered-out)');

            // Update no results messages
            const retailTab = document.getElementById('retail-tab');
            const foodserviceTab = document.getElementById('foodservice-tab');
            const deliveryTab = document.getElementById('delivery-tab');

            let retailNoResults = retailTab?.querySelector('.no-results');
            let foodserviceNoResults = foodserviceTab?.querySelector('.no-results');
            let deliveryNoResults = deliveryTab?.querySelector('.no-results');

            if (retailCards.length === 0 && retailTab) {
                if (!retailNoResults) {
                    retailNoResults = document.createElement('p');
                    retailNoResults.className = 'no-results';
                    retailNoResults.textContent = 'No retail partners found in ' + currentCountry + '. Check out our online shop!';
                    retailTab.appendChild(retailNoResults);
                } else {
                    retailNoResults.style.display = '';
                }
            } else if (retailNoResults) {
                retailNoResults.style.display = 'none';
            }

            if (foodserviceCards.length === 0 && foodserviceTab) {
                if (!foodserviceNoResults) {
                    foodserviceNoResults = document.createElement('p');
                    foodserviceNoResults.className = 'no-results';
                    foodserviceNoResults.textContent = 'No restaurant partners in ' + currentCountry + ' yet. Stay tuned!';
                    foodserviceTab.appendChild(foodserviceNoResults);
                } else {
                    foodserviceNoResults.style.display = '';
                }
            } else if (foodserviceNoResults) {
                foodserviceNoResults.style.display = 'none';
            }

            if (deliveryCards.length === 0 && deliveryTab) {
                if (!deliveryNoResults) {
                    deliveryNoResults = document.createElement('p');
                    deliveryNoResults.className = 'no-results';
                    deliveryNoResults.textContent = 'No delivery partners in ' + currentCountry + ' yet. Check back soon!';
                    deliveryTab.appendChild(deliveryNoResults);
                } else {
                    deliveryNoResults.style.display = '';
                }
            } else if (deliveryNoResults) {
                deliveryNoResults.style.display = 'none';
            }
        }

        // Change country button
        changeCountryBtn?.addEventListener('click', () => {
            if (countrySelector) {
                countrySelector.style.display = countrySelector.style.display === 'none' ? 'block' : 'none';
            }
        });

        // Country option buttons
        countryOptions.forEach(option => {
            option.addEventListener('click', () => {
                const country = option.dataset.country;
                if (country) setCountry(country);
            });
        });

        // Tab switching
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;

                // Update button states
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update tab content visibility
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // ZIP code search handlers
        zipSearchBtn?.addEventListener('click', handleZipSearch);

        zipInput?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleZipSearch();
            }
        });

        zipClearBtn?.addEventListener('click', clearZipSearch);

        // Initialize with locale-based country (no IP detection needed)
        initCountry();
    }

    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initStoreLocator);
    } else {
        initStoreLocator();
    }

    // Re-init after View Transitions
    document.addEventListener('astro:page-load', initStoreLocator);
</script>

<style>
    .store-locator {
        background: var(--planted-purple);
        padding: 5rem 1.5rem;
        position: relative;
        overflow: hidden;
    }

    .locator-inner {
        max-width: 1100px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }

    /* Header */
    .locator-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .locator-header h2 {
        font-size: clamp(2.5rem, 10vw, 4.5rem);
        color: white;
        margin-bottom: 0.5rem;
        line-height: 1;
    }

    .subtitle {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 1.5rem;
    }

    /* Country detection */
    .country-detected {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 100px;
        padding: 0.75rem 1.25rem;
        color: white;
        font-size: 0.95rem;
    }

    .detecting {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .detected {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .flag {
        font-size: 1.25rem;
    }

    .change-country {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 100px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        margin-left: 0.5rem;
    }

    .change-country:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Country selector */
    .country-selector {
        margin-top: 1rem;
    }

    .selector-inner {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
    }

    .country-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        color: white;
        padding: 0.6rem 1rem;
        border-radius: 100px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .country-option:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.3);
    }

    /* ZIP Code Input */
    .zip-input-wrapper {
        margin-top: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .zip-input-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.35rem;
    }

    .zip-input-inner {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 100px;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
        transition: all 0.3s;
    }

    .zip-input-inner:focus-within {
        background: rgba(255, 255, 255, 0.2);
        border-color: var(--planted-green);
        box-shadow: 0 0 0 3px rgba(139, 197, 63, 0.2);
    }

    .zip-icon {
        width: 18px;
        height: 18px;
        color: rgba(255, 255, 255, 0.7);
        flex-shrink: 0;
    }

    .zip-input {
        background: transparent;
        border: none;
        color: white;
        font-size: 1rem;
        font-family: inherit;
        font-weight: 600;
        width: 100px;
        padding: 0.5rem;
        outline: none;
    }

    .zip-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .zip-search-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: var(--planted-green);
        border: none;
        border-radius: 50%;
        color: var(--planted-purple);
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .zip-search-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(139, 197, 63, 0.4);
    }

    .zip-search-btn svg {
        width: 18px;
        height: 18px;
    }

    .zip-hint {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        transition: color 0.3s;
    }

    .zip-hint.error {
        color: #FF6B6B;
    }

    .zip-loading {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: white;
        font-size: 0.9rem;
    }

    .zip-result {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: rgba(139, 197, 63, 0.2);
        border: 2px solid var(--planted-green);
        border-radius: 100px;
        padding: 0.6rem 0.75rem 0.6rem 1.25rem;
        color: white;
    }

    .zip-result-text {
        font-size: 0.9rem;
        font-weight: 600;
    }

    .zip-clear-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .zip-clear-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .zip-clear-btn svg {
        width: 14px;
        height: 14px;
    }

    /* Tab navigation */
    .tab-nav {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
    }

    .tab-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid transparent;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 100px;
        font-family: inherit;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .tab-btn svg {
        width: 20px;
        height: 20px;
    }

    .tab-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .tab-btn.active {
        background: var(--planted-green);
        border-color: var(--planted-green);
        color: var(--planted-purple);
    }

    /* Tab content */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .foodservice-intro {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        max-width: 600px;
        margin: 0 auto 2rem;
    }

    /* Partners grid */
    .partners-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 2.5rem;
    }

    .partner-card {
        background: white;
        border-radius: 1.25rem;
        padding: 1.25rem;
        text-decoration: none;
        color: var(--planted-charcoal);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s var(--ease-out-expo), box-shadow 0.3s;
    }

    .partner-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
    }

    /* Use :global() to prevent Astro from tree-shaking this class
       since it's added dynamically by JavaScript */
    :global(.partner-card.filtered-out) {
        display: none !important;
    }

    .card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .partner-logo {
        width: 60px;
        height: 60px;
        background: var(--planted-cream);
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        overflow: hidden;
    }

    .partner-logo img {
        max-width: 80%;
        max-height: 80%;
        object-fit: contain;
    }

    .partner-initial {
        font-family: 'VC Henrietta', serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--planted-purple);
    }

    .partner-info {
        flex: 1;
        min-width: 0;
    }

    .partner-name {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.35rem;
        color: var(--planted-charcoal);
    }

    .partner-countries {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .country-badge {
        background: var(--planted-cream);
        color: var(--planted-purple);
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.15rem 0.5rem;
        border-radius: 100px;
    }

    .arrow-icon {
        width: 18px;
        height: 18px;
        color: var(--planted-purple);
        opacity: 0;
        transform: translate(-4px, 4px);
        transition: all 0.3s;
        flex-shrink: 0;
    }

    .partner-card:hover .arrow-icon {
        opacity: 0.6;
        transform: translate(0, 0);
    }

    /* Products preview */
    .products-preview {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .products-label {
        display: block;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(0, 0, 0, 0.4);
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .product-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
    }

    .product-pill {
        background: linear-gradient(135deg, var(--planted-purple), #8B3DB5);
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.25rem 0.6rem;
        border-radius: 100px;
    }

    .product-pill.more {
        background: var(--planted-green);
        color: var(--planted-purple);
    }

    /* Foodservice card specific */
    .foodservice-card .partner-description {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        font-size: 0.85rem;
        line-height: 1.5;
        color: rgba(0, 0, 0, 0.6);
    }

    /* Delivery tab styles */
    .delivery-intro {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        max-width: 600px;
        margin: 0 auto 2rem;
    }

    /* Chain restaurant grid */
    .chain-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2.5rem;
    }

    .chain-card {
        background: white;
        border-radius: 1.25rem;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: transform 0.3s var(--ease-out-expo), box-shadow 0.3s, opacity 0.3s;
        animation: cardFadeIn 0.4s ease-out forwards;
    }

    @keyframes cardFadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chain-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
    }

    :global(.chain-card.filtered-out) {
        display: none !important;
    }

    .chain-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .chain-meta {
        flex: 1;
        min-width: 0;
    }

    .chain-name-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.35rem;
    }

    .chain-name {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--planted-charcoal);
        margin: 0;
        line-height: 1.2;
    }

    .chain-locations-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        background: rgba(107, 57, 131, 0.1);
        color: var(--planted-purple);
        font-size: 0.7rem;
        font-weight: 700;
        padding: 0.2rem 0.5rem;
        border-radius: 100px;
    }

    .chain-locations-badge svg {
        width: 10px;
        height: 10px;
    }

    .chain-info {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
    }

    .chain-location {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.85rem;
        color: #666;
    }

    .chain-location svg {
        width: 14px;
        height: 14px;
        color: var(--planted-green);
    }

    .chain-cuisine {
        font-size: 0.8rem;
        color: var(--planted-purple);
        background: rgba(107, 57, 131, 0.1);
        padding: 0.2rem 0.6rem;
        border-radius: 100px;
    }

    /* Distance badge */
    .distance-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--planted-green), #7CB342);
        color: white;
        padding: 0.4rem 0.75rem;
        border-radius: 100px;
        font-size: 0.85rem;
        font-weight: 700;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(139, 197, 63, 0.3);
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s ease-out;
    }

    .distance-badge.animate-in {
        opacity: 1;
        transform: scale(1);
    }

    .chain-products {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        padding-top: 0.5rem;
    }

    .product-tag {
        background: linear-gradient(135deg, var(--planted-purple), #8B3DB5);
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.25rem 0.6rem;
        border-radius: 100px;
    }

    .chain-platforms {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .delivery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2.5rem;
    }

    .delivery-card {
        background: white;
        border-radius: 1.25rem;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: transform 0.3s var(--ease-out-expo), box-shadow 0.3s;
    }

    .delivery-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
    }

    :global(.delivery-card.filtered-out) {
        display: none !important;
    }

    .delivery-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .restaurant-meta {
        flex: 1;
        min-width: 0;
    }

    .restaurant-name {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--planted-charcoal);
        margin: 0 0 0.35rem;
        line-height: 1.2;
    }

    .restaurant-info {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
    }

    .restaurant-city {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.85rem;
        color: #666;
    }

    .restaurant-city svg {
        width: 14px;
        height: 14px;
    }

    .restaurant-cuisine {
        font-size: 0.8rem;
        color: var(--planted-purple);
        background: rgba(107, 57, 131, 0.1);
        padding: 0.2rem 0.6rem;
        border-radius: 100px;
    }

    .restaurant-rating {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        background: #FFF8E1;
        color: #F59E0B;
        padding: 0.35rem 0.7rem;
        border-radius: 100px;
        font-size: 0.9rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .restaurant-rating svg {
        width: 14px;
        height: 14px;
    }

    /* Dish menu styles */
    .dish-menu {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem 0;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .dish-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .dish-info {
        flex: 1;
        min-width: 0;
    }

    .dish-name-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 0.25rem;
    }

    .dish-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--planted-charcoal);
    }

    .vegan-badge {
        background: linear-gradient(135deg, var(--planted-green), #7CB342);
        color: white;
        font-size: 0.65rem;
        font-weight: 700;
        padding: 0.15rem 0.5rem;
        border-radius: 100px;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .dish-description {
        font-size: 0.8rem;
        color: #777;
        line-height: 1.4;
        margin: 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .dish-price {
        font-weight: 700;
        font-size: 0.95rem;
        color: var(--planted-green);
        white-space: nowrap;
        flex-shrink: 0;
    }

    /* Delivery platform buttons */
    .delivery-platforms {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .platform-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.6rem 1rem;
        background: var(--platform-color, #333);
        color: white;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .platform-btn:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
    }

    .platform-btn svg {
        width: 14px;
        height: 14px;
        opacity: 0.85;
    }

    /* No results */
    .no-results {
        text-align: center;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
        padding: 2rem;
    }

    /* No delivery available state */
    .zip-result.no-delivery {
        background: rgba(255, 107, 107, 0.15);
        border-color: rgba(255, 107, 107, 0.5);
    }

    .zip-result.no-delivery .zip-result-text {
        color: #FFB4B4;
    }

    /* No delivery message with alternatives */
    :global(.no-delivery-message) {
        background: rgba(255, 255, 255, 0.08);
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-radius: 1.25rem;
        padding: 2.5rem 2rem;
        text-align: center;
        margin-bottom: 2rem;
        animation: fadeInUp 0.4s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    :global(.no-delivery-message .no-delivery-icon) {
        width: 64px;
        height: 64px;
        margin: 0 auto 1.25rem;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    :global(.no-delivery-message .no-delivery-icon svg) {
        width: 32px;
        height: 32px;
        color: rgba(255, 255, 255, 0.6);
    }

    :global(.no-delivery-message h3) {
        color: white;
        font-size: 1.35rem;
        font-weight: 700;
        margin: 0 0 0.5rem;
    }

    :global(.no-delivery-message p) {
        color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
        margin: 0 0 1.5rem;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
    }

    :global(.no-delivery-alternatives) {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
    }

    :global(.alt-btn) {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.85rem 1.5rem;
        border-radius: 100px;
        font-size: 0.95rem;
        font-weight: 600;
        font-family: inherit;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        background: rgba(255, 255, 255, 0.15);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    :global(.alt-btn:hover) {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    :global(.alt-btn svg) {
        width: 18px;
        height: 18px;
    }

    :global(.alt-btn-primary) {
        background: var(--planted-green);
        border-color: var(--planted-green);
        color: var(--planted-purple);
    }

    :global(.alt-btn-primary:hover) {
        background: #9BD55A;
        border-color: #9BD55A;
        box-shadow: 0 6px 20px rgba(139, 197, 63, 0.35);
    }

    /* Online CTA */
    .online-cta {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.15);
        border-radius: 1.25rem;
        padding: 1.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.25rem;
        text-align: center;
    }

    .cta-content {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .cta-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--planted-green);
        font-weight: 700;
    }

    .cta-text {
        color: white;
        font-size: 1rem;
    }

    .btn-cta {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--planted-green);
        color: var(--planted-purple);
        padding: 0.85rem 1.75rem;
        border-radius: 100px;
        font-weight: 700;
        text-decoration: none;
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .btn-cta:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(139, 197, 63, 0.4);
    }

    .btn-cta svg {
        width: 18px;
        height: 18px;
        transition: transform 0.3s;
    }

    .btn-cta:hover svg {
        transform: translateX(4px);
    }

    /* Background decoration */
    .bg-pattern {
        position: absolute;
        inset: 0;
        background-image:
            radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.03) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(139, 197, 63, 0.05) 0%, transparent 40%);
        pointer-events: none;
    }

    /* Responsive */
    @media (min-width: 640px) {
        .partners-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .online-cta {
            flex-direction: row;
            justify-content: space-between;
            text-align: left;
        }
    }

    @media (min-width: 768px) {
        .partners-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }
    }

    @media (min-width: 1024px) {
        .store-locator {
            padding: 6rem 3rem;
        }

        .partners-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (min-width: 1440px) {
        .store-locator {
            padding: 7rem 5rem;
        }

        .locator-inner {
            max-width: 1300px;
        }
    }
</style>
